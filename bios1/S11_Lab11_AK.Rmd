---
title: "Propensity Scores Answer Key"
author: "BIOS 620"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup load HELP RCT data

```{r}
library(haven)
rct <- read_spss("data/data_HELP.sav")
```

# Instructions

* Come up with a different model to estimate the propensity score

### Additional setup

Here we create a factor out of the `racegrp` variable:

```{r}
rct$racegrp <- factor(rct$racegrp)
```

## Produce the propensity score

We include variables that are related to both the study variable and the
outcome.

```{r}
m_ps <- glm(homeless ~ 1 + age + female + racegrp + substance,
    family=binomial, data=rct)
summary(m_ps)
```

## Merge to dataset

```{r}
prs_df <- data.frame(
    pr_score = predict(m_ps, type ="response"),
    homeless = m_ps$model$homeless
)
rct$pr_score <- predict(m_ps, type ="response")

head(prs_df)
```

## Histograms by homeless status

```{r}
par(mfrow = c(1, 2))
hist(prs_df[prs_df$homeless == 0, "pr_score"])
hist(prs_df[prs_df$homeless == 1, "pr_score"])
```

## Matching

The method we use below is to find pairs of observations that have very similar
propensity scores, based on certain measures of **similarity**.

We use the package MatchIt for this. This package estimates the propensity score
in the background and then matches observations based on the method of choice.

```{r}
library(MatchIt)
vars <- c("cesd", "homeless", "age", "female", "racegrp", "substance")
rct_nomiss <- rct[complete.cases(rct[, vars]), vars]

mod_match <- matchit(homeless ~ age + female + racegrp + substance,
    method = "nearest",  replace=FALSE, ratio=1, data=rct_nomiss)
```

We can get some information about how successful the matching was using:

```{r}
par(mfrow = c(1, 1))
class(mod_match)
summary(mod_match)
plot(mod_match)
```

## Examine the matched data

To create a data.frame containing only the matched observations, use the
`match.data()` function:

```{r}
dta_m <- match.data(mod_match)
dim(dta_m)
dim(rct)
head(dta_m, 4)
```

# Assessments of the covariance balance in your matched sample

## Visual inspection (e.g., with covariate Age)

```{r}
par(mfrow=c(1,1))

plot(dta_m$distance[dta_m$homeless==0],  dta_m$age[dta_m$homeless==0],
    xlab="Propensity Score", ylab="Age", las=1)

points(dta_m$distance[dta_m$homeless==1],  dta_m$age[dta_m$homeless==1], pch=2)

legend("topleft", pch=c(1,2), c("Homeless 0", "Homeless 1"))
```

## Difference in means (e.g., the Age variable)

```{r}
tapply(X = dta_m$age, INDEX = dta_m$homeless, FUN = mean)
```

# Estimating treatment effects

Estimating the risk effect is simple once we have a matched sample that we are
happy with.

```{r}
fit1 <- lm(cesd ~ homeless, data = dta_m, weights = weights)
```

## Cluster-robust standard errors

First we inspect the data and we can also check the `subclass` variable
that corresponds to the matched pairs in the data (1:1 matching).

```{r}
head(dta_m)
## cluster identifier
table(dta_m$subclass)
```

```{r}
library(lmtest)
coeftest(fit1,  cluster = ~ subclass)
coefci(fit1, cluster = ~ subclass)
```

